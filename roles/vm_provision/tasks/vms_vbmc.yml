- name: Install python3-pip package
  ansible.builtin.dnf:
    name: python3-pip
    state: present
    update_cache: yes

- name: Install virtualbmc via pip
  ansible.builtin.pip:
    name: virtualbmc
    state: present

- name: Verify vbmc executable exists  
  ansible.builtin.stat:
    path: /usr/local/bin/vbmc
  register: vbmc_executable
  failed_when: not vbmc_executable.stat.exists

- name: Check if vbmcd is already running
  ansible.builtin.command: pgrep -f vbmcd
  register: vbmcd_running
  ignore_errors: yes
  changed_when: false

- name: Start vbmcd temporarily to initialize (only if not running)
  ansible.builtin.command: /usr/local/bin/vbmcd
  when: vbmcd_running.rc != 0
  async: 5
  poll: 0

- name: Wait a moment for vbmcd to initialize
  ansible.builtin.wait_for:
    timeout: 5
  when: vbmcd_running.rc != 0

- name: Add VirtualBMC instances
  ansible.builtin.command: >
    /usr/local/bin/vbmc add {{ item.name }}
    --port {{ item.port }}
    --username admin
    --password {{ vbmc_password | quote }}
  args:
    creates: "/root/.vbmc/{{ item.name }}"
  loop: "{{ vbmc_controller_instances | union(vbmc_compute_instances) }}"

- name: Stop any running vbmcd processes
  ansible.builtin.command: pkill vbmcd
  ignore_errors: yes
  changed_when: false

- name: Create vbmcd systemd service file
  ansible.builtin.template:
    src: vbmcd.service.j2
    dest: /etc/systemd/system/vbmcd.service
    mode: '0644'

- name: Reload systemd and enable vbmcd service
  ansible.builtin.systemd:
    name: vbmcd
    enabled: yes
    state: started
    daemon_reload: yes

- name: Extract MAC addresses for all VBMC instances
  ansible.builtin.shell: |
    virsh dumpxml {{ item.name }} | xmllint --xpath "//interface/source[@network='br-provisioning']/parent::*/mac/@address" - 2>/dev/null | cut -d'"' -f2
  loop: "{{ vbmc_controller_instances | union(vbmc_compute_instances) }}"
  register: mac_addresses
  changed_when: false

- name: Create nodes.yaml dynamically
  ansible.builtin.template:
    src: nodes.yaml.j2
    dest: /root/nodes.yaml
    mode: '0644'

- name: Create fencing.yaml dynamically
  ansible.builtin.template:
    src: fencing.yaml.j2
    dest: /root/fencing.yaml
    mode: '0644'
